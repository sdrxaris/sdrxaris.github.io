<!DOCTYPE html>
<html>
<head>
	<style>
		#grad {
  		background-image: linear-gradient(red, yellow);
		}
		@font-face {
			font-family = 'Aller';
			src: url('../fonts/Aller_Rg.woff');

		}
	</style>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Pixi Game</title>
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
	<script>
		//Variables
		let enemy;
		let myWidth = 800, myHeight = 600;
		let app;
		let player;
		let bullets = [];
		let bulletSpeed = 10;
		let movingUp = false, movingDown = false, movingRight = false, movingLeft = false;
		let gameOn = false;
		//Loading 
		window.onload = function() {
			app = new PIXI.Application({
				width: myWidth, 
				height: myHeight
			});
			document.querySelector("#gamePlace").appendChild(app.view);
			app.stage.interactive = true;

			

			//Events Added
			app.ticker.add(gameLoop);

			document.querySelector("#gamePlace").addEventListener("pointerdown", fireBullet);
			window.addEventListener("keydown", keysDown);
			window.addEventListener("keyup", keysUp);

			//The game screens defining
			loadingTitleScreen = new PIXI.Container();
			mainMenuScreen = new PIXI.Container();
			singlePlayerScreen = new PIXI.Container();

			mainMenuScreen.visible = false;
			singlePlayerScreen.visible = false;
			app.stage.addChild(loadingTitleScreen);
			app.stage.addChild(mainMenuScreen);
			app.stage.addChild(singlePlayerScreen);
			//setup loadingTitleScreen
			let circle = new PIXI.Graphics()
			.beginTextureFill(gradient('#373B44', '#4286f4'))
		  	.drawRect (0, 0, myWidth, myHeight);
			loadingTitleScreen.addChild(circle);
			let text1 = new PIXI.Text("Loading...");
			text1.anchor.set(0.5);
			text1.x = myWidth / 2;
			text1.y = myHeight / 2;
			text1.style = new PIXI.TextStyle({
				fill: 0x000000,
				fontsize: 40,
				fontFamily: "Aller",
				fontStyle: "bold",
				stroke: 0xFFFFFF,
				strokeThickness: 3
			});
			loadingTitleScreen.addChild(text1);

			//setup mainMenuScreen
			let circle2 = new PIXI.Graphics()
			.beginTextureFill(gradient('#3ACFAC', '#FACCAF'))
		  	.drawRect (0, 0, myWidth, myHeight);
			mainMenuScreen.addChild(circle2);
			let text2 = new PIXI.Text("Main.");
			text2.anchor.set(0.5);
			text2.x = myWidth / 2;
			text2.y = myHeight / 2;
			text2.style = new PIXI.TextStyle({
				fill: 0x000000,
				fontsize: 40,
				fontFamily: "Aller",
				fontStyle: "bold",
				stroke: 0xFFFFFF,
				strokeThickness: 3
			});
			mainMenuScreen.addChild(text2);

			//setup singlePlayerScreen 
			let circle3 = new PIXI.Graphics()
			.beginTextureFill(gradient('#ABCDEF', '#412341'))
		  	.drawRect (0, 0, myWidth, myHeight);
			singlePlayerScreen.addChild(circle3);
			let text3 = new PIXI.Text("Play.");
			text3.anchor.set(0.5);
			text3.x = myWidth / 2;
			text3.y = myHeight / 2;
			text3.style = new PIXI.TextStyle({
				fill: 0x000000,
				fontsize: 40,
				fontFamily: "Aller",
				fontStyle: "bold",
				stroke: 0xFFFFFF,
				strokeThickness: 3
			});
			singlePlayerScreen.addChild(text3);

		}
		function updateBullets(delta)
		{
			for(let i = 0; i < bullets.length; i++)
			{
				bullets[i].position.x += bullets[i].direction.x*bullets[i].speed;
    			bullets[i].position.y += bullets[i].direction.y*bullets[i].speed;



				if(rectsIntersect(bullets[i], enemy))
				{
					enemy.x += bullets[i].speed * bullets[i].direction.x;
					enemy.y += bullets[i].speed * bullets[i].direction.y;
					app.stage.removeChild(bullets[i]);
					bullets.splice(i, 1);
					return;
				}
				if(bullets[i].position.y < 0)
				{
					app.stage.removeChild(bullets[i]);
					bullets.splice(i, 1);
				}
			}
		}
		
		function gameLoop(delta)
		{
			if(gameOn)
			{
				//updateBullets(delta);
			}
		}
		function rectsIntersect(a, b)
		{
			let aBox = a.getBounds();
			let bBox = b.getBounds();
			return aBox.x + aBox.width > bBox.x && aBox.x < bBox.x + bBox.width && aBox.y + aBox.height > bBox.y && aBox.y < bBox.y + bBox.height;
		}
		function keysDown(e)
		{
			switch (e.key) {
				case "1":
					loadingTitleScreen.visible = true;
					mainMenuScreen.visible = false;
					singlePlayerScreen.visible = false;
				break;
				case "2":
					loadingTitleScreen.visible = false;
					mainMenuScreen.visible = true;
					singlePlayerScreen.visible = false;
				break;
				case "3":
					let players = [];
					loadingTitleScreen.visible = false;
					mainMenuScreen.visible = false;
					singlePlayerScreen.visible = true;

					let socket = io();		
					app.socket = socket;
					socket.on('playerJoined', function (data)
					{
						player = new PIXI.Sprite.from("/client/images/player.png");
						player.anchor.set(0.5);
						player.x = data.x;
						player.id = data.id;
						player.y = data.y;
						player.speed = 4;
						app.stage.addChild(player);
						players.push(player);
					});
					socket.on('playerLeft', function (data)
					{
						for(let i = 0; i < players.length; i ++)
						{
							if(players[i].id = data.id)
							{
								console.log("Player " + players[i].id + " left");
								app.stage.removeChild(players[i]);
								players.splice(i, 1);
							}
						}
					});
					socket.on('newPositions', function (data)
					{
						for(var i = 0; i < data.length; i++)
						{
							for(var k = 0 ; k < players.length; k ++)
							{
								if(players[k].id == data[i].id)
								{
									players[k].x = data[i].x;
									players[k].y = data[i].y;
								}
							}
						}
					});
					/*enemy = new PIXI.Sprite.from("/client/images/enemy.png");
					enemy.anchor.set(0.5);
					enemy.x = myWidth / 2;
					enemy.y = 60;
					app.stage.addChild(enemy);*/
					gameOn = true;

				break;
				case "w":
					if(gameOn) app.socket.emit("movingUp", {status:"true"});
				break;
				case "s":
					if(gameOn) app.socket.emit("movingDown", {status:"true"});
				break;
				case "d":
					if(gameOn) app.socket.emit("movingRight", {status:"true"});
				break;
				case "a":
					if(gameOn) app.socket.emit("movingLeft", {status:"true"});
				break;
			}
		}
		function keysUp(e)
		{
			switch (e.key)
			{
				case "w":
					if(gameOn) app.socket.emit("movingUp", {status:"false"});
				break;
				case "s":
					if(gameOn) app.socket.emit("movingDown", {status:"false"});
				break;
				case "d":
					if(gameOn) app.socket.emit("movingRight", {status:"false"});
				break;
				case "a":
					if(gameOn) app.socket.emit("movingLeft", {status:"false"});
				break;
			}
		}
		function fireBullet(e)
		{
			let bullet = createBullet(e.offsetX, e.offsetY);
			bullets.push(bullet);
		}
		function createBullet(destiX, destiY)
		{
			let bullet = new PIXI.Sprite.from("/client/images/bullet.png");
			bullet.anchor.set(0.5);
			var direction = {};
		    direction.x = destiX - player.x;
		    direction.y = destiY - player.y;
		    var length = Math.sqrt( direction.x*direction.x + direction.y*direction.y);
			direction.x/=length;
			direction.y/=length;
			bullet.direction = direction;
			bullet.x = player.x;
			bullet.speed = bulletSpeed;
			bullet.y = player.y;
			app.stage.addChild(bullet);
			return bullet;
		}
		function gradient(from, to) {
		  const c = document.createElement("canvas");
		  const ctx = c.getContext("2d");
		  const grd = ctx.createLinearGradient(0,0,myWidth,myHeight);
		  grd.addColorStop(0, from);
		  grd.addColorStop(1, to);
		  ctx.fillStyle = grd;
		  ctx.fillRect(0,0,myWidth,myHeight);
		  return new PIXI.Texture.from(c);
		}
	</script>
</head>
<body>
	<div align = "center" border="1" class="grad" id="gamePlace"></div>
</body>
</html>